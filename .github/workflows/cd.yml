name: cd
on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deployment Workflow
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
      id-token: write   # Required for SBOM attestation
      attestations: write  # Required for SBOM generation and attestation

    steps:
      # Step 1: Clone the repository
      - name: Clone repository
        uses: actions/checkout@v3

      # Step 2: Configure Python Environment
      - name: Set up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: 3.13

      # Step 3: Install Required Tools
      - name: Install Poetry and CycloneDX
        run: |
          python -m pip install --upgrade pip
          pip install poetry cyclonedx-bom

      # Step 4: Install Project Dependencies
      - name: Install Dependencies with Poetry
        working-directory: py_rekor_monitor_ss17542_sscs
        run: poetry install --no-root

      # Step 5: Build the Python Project
      - name: Build Project
        working-directory: py_rekor_monitor_ss17542_sscs
        run: poetry build --format wheel

      # Step 6: Generate Software Bill of Materials (SBOM)
      - name: Create SBOM 
        run: cyclonedx-py poetry --output-format json > cyclonedx-sbom.json

      # Step 7: Sign and Attest SBOM
      - name: Detect Wheel File
        id: detect_wheel
        working-directory: py_rekor_monitor_ss17542_sscs
        run: echo "WHEEL_FILE=$(ls dist/*.whl)" >> $GITHUB_ENV
      - name: Attest SBOM
        uses: actions/attest-sbom@v2.1.0
        with:
          subject-path: py_rekor_monitor_ss17542_sscs/$WHEEL_FILE
          sbom-path: py_rekor_monitor_ss17542_sscs/cyclonedx-sbom.json

      # Step 8: Upload Artifacts to Release
      - name: Publish Artifacts to Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
           dist/py_rekor_monitor_ss17542_sscs-${{ github.ref_name }}-py3-none-any.whl
           dist/py_rekor_monitor_ss17542_sscs-${{ github.ref_name }}.tar.gz
